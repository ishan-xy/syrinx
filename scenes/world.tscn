[gd_scene load_steps=3 format=3 uid="uid://evubvr3xftm7"]

[ext_resource type="TileSet" uid="uid://dqujacqvd0g2o" path="res://components/mystic.tres" id="3_mhhl7"]

[sub_resource type="GDScript" id="GDScript_d5htu"]
script/source = "extends Node2D

# TODO: Implement manual syncronization of player's properties

# TODO: encode player's animation info etc into 2 bytes short for multiplayer
# 2 bits for movement direction, 3 for action 1 for movement direction,
# 10 for delta (+- 4 blocks) subdevided into 2^7 (128) parts
# WARNING: this may become a problem as delta's need to be sent in-order
# WARNING: we need to sync posotion (once per second) in as this is not precise


# This is to be used for testing only
const IS_SERVER: bool = false
#func _ready():
	#if IS_SERVER:
		#_on_host_pressed()
	#else:
		#_on_join_pressed()

# server's port
const PORT = 3001

# ENetMultiplayerPeer is faster but incompatiblle with browsers
var peer := WebSocketMultiplayerPeer.new()

# WARNING: `player_scene` has to be set in the ui of \"Multiplayer Syncronizer\"
@export var player_scene: PackedScene

func _on_host_pressed():
	peer.create_server(PORT)
	multiplayer.multiplayer_peer = peer
	multiplayer.peer_connected.connect(add_player)
	add_player()
	$Camera2D.enabled = false

func _on_join_pressed():
	peer.create_client(\"ws://127.0.0.1:\"+str(PORT)+\"/\")
	multiplayer.multiplayer_peer = peer
	$Camera2D.enabled = false

func add_player(id = 1):
	var player := player_scene.instantiate()
	player.name = str(id)
	call_deferred(\"add_child\", player)

func exit_game(id):
	multiplayer.peer_disconnected.connect(del_player)
	del_player(id)

func del_player(id):
	rpc(\"_del_player\", id)

@rpc(\"any_peer\", \"call_local\") func _del_player(id):
	get_node(str(id)).queue_free()
"

[node name="World" type="Node2D"]
y_sort_enabled = true
script = SubResource("GDScript_d5htu")

[node name="TileMap" type="TileMap" parent="."]
y_sort_enabled = true
position = Vector2(-96, 64)
tile_set = ExtResource("3_mhhl7")
format = 2
layer_0/name = "bg"
layer_0/y_sort_enabled = true
layer_0/tile_data = PackedInt32Array(-196586, 131073, 2, -262122, 131073, 1, -327658, 131073, 1, -393194, 327681, 1, -196587, 131073, 2, -262123, 131073, 1, -327659, 131073, 1, -393195, 131073, 0, -196588, 131073, 2, -262124, 131073, 1, -327660, 131073, 1, -393196, 131073, 0, -196589, 131073, 2, -262125, 131073, 1, -327661, 131073, 1, -393197, 131073, 0, -196590, 131073, 2, -262126, 131073, 1, -327662, 131073, 1, -393198, 131073, 0, -196591, 131073, 2, -262127, 131073, 1, -327663, 131073, 1, -393199, 131073, 0, -196592, 131073, 2, -262128, 131073, 1, -327664, 131073, 1, -393200, 131073, 0, -196593, 131073, 2, -262129, 131073, 1, -327665, 131073, 1, -393201, 131073, 0, -196594, 131073, 2, -262130, 131073, 1, -327666, 131073, 1, -393202, 131073, 0, -196595, 131073, 2, -262131, 131073, 1, -327667, 131073, 1, -393203, 131073, 0, -196596, 131073, 2, -262132, 131073, 1, -327668, 131073, 1, -196597, 131073, 2, -262133, 131073, 1, -327669, 131073, 1, -393205, 131073, 0, -196598, 131073, 2, -262134, 131073, 1, -327670, 131073, 1, -393206, 131073, 0, -196599, 131073, 2, -262135, 131073, 1, -327671, 131073, 1, -393207, 131073, 0, -196600, 131073, 2, -262136, 131073, 1, -327672, 131073, 1, -393208, 131073, 0, -196584, 196609, 2, -262120, 196609, 1, -327656, 196609, 1, -196585, 131073, 2, -262121, 131073, 1, -327657, 131073, 1, -393193, 131073, 1, -458728, 196609, 1, -524264, 196609, 1, -589800, 262145, 0, -655336, 131073, 1, -720872, 131073, 1, -786408, 262145, 1, -851944, 196609, 1, -917480, 196609, 1, -983016, 196609, 1, -1048552, 196609, 0, -458729, 131073, 1, -524265, 131073, 1, -589801, 131073, 1, -655337, 131073, 1, -720873, 131073, 1, -786409, 131073, 1, -851945, 131073, 1, -917481, 131073, 1, -983017, 131073, 1, -1048553, 131073, 0, -458730, 65537, 1, -524266, 65537, 1, -589802, 65537, 1, -655338, 65537, 1, -720874, 65537, 1, -786410, 65537, 1, -851946, 65537, 1, -917482, 65537, 1, -983018, 65537, 1, -1048554, 65537, 0, -589794, 196609, 2, -655330, 196609, 1, -720866, 196609, 1, -786402, 196609, 1, -589795, 131073, 2, -655331, 131073, 1, -720867, 131073, 1, -786403, 327681, 1, -589796, 131073, 2, -655332, 131073, 1, -720868, 131073, 1, -786404, 131073, 0, -589797, 131073, 2, -655333, 131073, 1, -720869, 131073, 1, -786405, 131073, 0, -589798, 131073, 2, -655334, 131073, 1, -720870, 131073, 1, -786406, 131073, 0, -589799, 131073, 2, -655335, 131073, 1, -720871, 131073, 1, -786407, 131073, 0, -851938, 196609, 1, -917474, 327684, 0, -851939, 65537, 1, -917475, 327684, 0, -589793, 4, 5, -262119, 4, 5, -524268, 4, 5, -524270, 524292, 6, -524272, 524292, 6, -524274, 524292, 6, -589809, 524292, 6, -589807, 524292, 6, -589811, 524292, 6, -131059, 524292, 6, -65522, 524292, 6, -131057, 524292, 6, -65520, 524292, 6, -131055, 524292, 6, -65518, 524292, 6, -131061, 393220, 7, -131063, 393220, 7, -131052, 4, 5, -131049, 4, 5, -786412, 4, 5, -393204, 131073, 0, -458743, 393220, 7, -458741, 393220, 7, -524260, 655364, 0, -851942, 655364, 0, -851940, 4, 0, -1114089, 655364, 7, -1048555, 655364, 7, -655340, 655364, 7, -458727, 655364, 7, -393192, 196609, 1, -196601, 131073, 2, -262137, 131073, 1, -327673, 131073, 1, -393209, 131073, 0, -196602, 131073, 2, -262138, 131073, 1, -327674, 131073, 1, -393210, 131073, 0, -196603, 131073, 2, -262139, 131073, 1, -327675, 131073, 1, -393211, 131073, 0, -196604, 65537, 2, -262140, 65537, 1, -327676, 65537, 1, -393212, 65537, 0, -131069, 65537, 6, -196605, 1, 5, -262141, 1, 5, -327677, 1, 5, -393213, 1, 4, -131065, 196609, 7, -131066, 131073, 7, -131067, 131073, 7, -131068, 131073, 7)

[node name="MultiplayerSpawner" type="MultiplayerSpawner" parent="."]
_spawnable_scenes = PackedStringArray("res://scenes/player.tscn")
spawn_path = NodePath("..")
spawn_limit = 10

[node name="Host" type="Button" parent="."]
offset_top = -16.0
offset_right = 64.0
offset_bottom = 15.0
scale = Vector2(0.5, 0.5)
text = "HOST"

[node name="Join" type="Button" parent="."]
offset_right = 64.0
offset_bottom = 31.0
scale = Vector2(0.5, 0.5)
text = "JOIN"

[node name="Camera2D" type="Camera2D" parent="."]
position = Vector2(16, 0)

[connection signal="pressed" from="Host" to="." method="_on_host_pressed"]
[connection signal="pressed" from="Join" to="." method="_on_join_pressed"]
